<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Wallet {{ wallet }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/portfolio.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/wallet.css') }}">
</head>
<body class="bg-[#e8e8e8] min-h-screen flex flex-col items-center">
    {% include 'components/navbar.html' %}

    <main class="w-full max-w-[900px] mt-10 p-6 bg-white rounded-xl shadow-lg">
        <div class="mb-8 p-4 border border-gray-200 rounded-lg bg-gray-50">
            <h1 class="text-2xl font-bold mb-2 flex items-center">
                <i class="fas fa-wallet mr-3 text-red-gradient"></i>
                Wallet Analysis
            </h1>
            <div class="flex items-center justify-between">
                <div class="font-mono text-lg">
                    <span class="wallet-address" title="{{ wallet }}">
                        {{ wallet[:6] }}...{{ wallet[-4:] }}
                    </span>
                    <button onclick="copyWallet('{{ wallet }}')" class="copy-btn ml-2 text-gray-400 hover:text-[#FF3200]">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                {% if xp_rank %}
                <span class="bg-red-gradient text-white px-3 py-1 rounded-full text-sm font-bold">
                    Rank #{{ xp_rank }}
                </span>
                {% endif %}
            </div>
        </div>

        {% if error %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
                <i class="fas fa-exclamation-circle mr-2"></i>
                {{ error }}
            </div>
            <a href="/" class="text-[#FF3200] hover:underline">
                <i class="fas fa-arrow-left mr-1"></i> Back to Home
            </a>
        {% else %}
            <!-- Sección Leaderboard -->
            <div class="mb-8">
                <h2 class="text-xl font-bold mb-2 flex items-center">
                    <i class="fas fa-trophy mr-2 text-red-gradient"></i>
                    Leaderboard Context
                </h2>
                <p class="text-gray-600 mb-4">
                    Showing wallets around rank {{ xp_rank }}
                </p>
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Rank</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Wallet</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">Plume Points</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">TVL (USD)</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">Activity PP</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">Referral PP</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">Staked PLUME</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">Points Difference</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for row in leaderboard %}
                            <tr class="{% if row.walletAddress.lower() == wallet.lower() %}bg-gray-100 font-medium{% else %}hover:bg-gray-50{% endif %}">
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                    {{ row.xpRank }}
                                    {% if row.walletAddress.lower() == wallet.lower() %}
                                    <span class="ml-1 text-[#FF3200]">(YOU)</span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-mono">
                                    {{ row.walletAddress[:6] }}...{{ row.walletAddress[-4:] }}
                                    <button onclick="copyWallet('{{ row.walletAddress }}')" 
                                            class="copy-btn ml-2 text-gray-400 hover:text-[#FF3200]">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 text-right">
                                    {{ "{:,.0f}".format(row.totalXp) }}
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 text-right">
                                    ${{ "{:,.2f}".format(row.TVL) }}
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 text-right">
                                    {{ "{:,.0f}".format(row.userSelfXp) }}
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 text-right">
                                    {{ "{:,.0f}".format(row.referralBonusXp) }}
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 text-right">
                                    {{ "{:,.2f}".format(row.currentPlumeStakingTotalTokens) }}
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-right">
                                    {% if row.walletAddress.lower() == wallet.lower() %}
                                    <span class="text-gray-500">-</span>
                                    {% else %}
                                    <span class="{% if row.pointsDifference > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                        {{ "{:+,.0f}".format(row.pointsDifference) }}
                                    </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sección Heatmap -->
            {% if heatmap_data %}            
                {% include 'components/github_style_heatmap.html' %}
            {% else %}
                <div class="mt-8 p-4 bg-yellow-50 text-yellow-800 rounded-lg">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    No activity data available for this wallet
                </div>
            {% endif %}

            <!-- Sección Portfolio -->
            {% if tokens and plume_price %}
            <div class="mt-12">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-chart-pie mr-2 text-red-gradient"></i>
                    Portfolio Analysis
                </h2>
                
                <!-- Resumen Portfolio -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-red-gradient text-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Total Value</p>
                                <p class="text-xl font-bold">${{ "%.2f"|format(total_value) }}</p>
                            </div>
                            <i class="fas fa-coins text-xl opacity-80"></i>
                        </div>
                    </div>
                    
                    <div class="bg-white border border-gray-200 p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">PLUME Price</p>
                                <p class="text-lg font-bold">${{ "%.6f"|format(plume_price) }}</p>
                            </div>
                            <i class="fas fa-chart-line text-xl text-[#FF3200]"></i>
                        </div>
                    </div>
                    
                    <div class="bg-white border border-gray-200 p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">PLUME Staked</p>
                                <p class="text-lg font-mono">
                                    {% set plume_staked = tokens|selectattr('symbol', 'equalto', 'PLUME-staked')|map(attribute='balance')|sum %}
                                    {{ "%.2f"|format(plume_staked) }} (${{ "%.2f"|format(plume_staked * plume_price) }})
                                </p>
                            </div>
                            <i class="fas fa-lock text-xl text-[#FF3200]"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Gráfico y Tabla -->
                <div class="bg-white p-4 rounded-lg shadow-lg mb-6">
                    <div class="h-64">
                        <canvas id="portfolioChart"></canvas>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-lg shadow-lg">
                    <div class="overflow-x-auto">
                        <table class="min-w-full compact-table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="text-left">Asset</th>
                                    <th class="text-left">Type</th>
                                    <th class="text-right">Value/Balance</th>
                                    <th class="text-right">% Portfolio</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                {% for token in tokens %}
                                <tr class="hover:bg-gray-50">
                                    <td class="whitespace-nowrap py-2">
                                        <div class="flex items-center">
                                            {% if token.symbol == 'PLUME-staked' %}
                                                <i class="fas fa-lock text-[#FF3200] mr-2"></i>
                                            {% elif token.logo %}
                                                <img src="{{ token.logo }}" class="token-logo">
                                            {% else %}
                                                <div class="token-logo bg-gray-200 flex items-center justify-center">
                                                    <i class="fas fa-coins text-xs text-gray-500"></i>
                                                </div>
                                            {% endif %}
                                            <div>
                                                <div class="font-medium">{{ token.name }}</div>
                                                <div class="text-xs text-gray-500">{{ token.symbol }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="whitespace-nowrap py-2">
                                        {% if token.symbol == 'PLUME-staked' %}
                                            <span class="staking-badge">Staking</span>
                                        {% else %}
                                            <span class="token-badge">Token</span>
                                        {% endif %}
                                    </td>
                                    <td class="whitespace-nowrap py-2 text-right">
                                        <div class="font-mono">${{ "%.2f"|format(token.value_usd) }}</div>
                                        <div class="text-xs text-gray-500 font-mono">
                                            {{ "%.4f"|format(token.balance) }} @ ${{ "%.6f"|format(token.price) }}
                                        </div>
                                    </td>
                                    <td class="whitespace-nowrap py-2">
                                        <div class="flex items-center justify-end">
                                            <span class="text-xs mr-2">{{ "%.1f"|format(token.percentage) }}%</span>
                                            <div class="progress-container">
                                                <div class="progress-fill" style="width: {{ token.percentage }}%"></div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        {% endif %}
    </main>

    <script src="{{ url_for('static', filename='js/wallet-utils.js') }}"></script>
    <script>
        // Portfolio Chart
        if (document.getElementById('portfolioChart')) {
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            const tokens = JSON.parse('{{ tokens|tojson|safe }}');
            
            const backgroundColors = [
                '#FF3200', '#FF5E00', '#FF8130', '#FFA05A', '#FFC38B',
                '#FFD1A3', '#FFDFBB', '#FFEBD1', '#FFF5E8'
            ];
            
            const chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: tokens.map(t => t.symbol),
                    datasets: [{
                        data: tokens.map(t => t.value_usd),
                        backgroundColor: backgroundColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                padding: 15,
                                font: {
                                    family: "'Poppins', sans-serif",
                                    size: 10
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
        }
    </script>
</body>
</html> 